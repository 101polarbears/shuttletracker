<polymer-element name="shuttles-map" attributes="lat lng zoom">
  <template>
    <style>
      :host {
        width: 100%;
        height: 100%;
      }
      #mapCanvas {
        width: 100%;
        height: 100%;
      }
    </style>
    <div id="mapCanvas"> </div>
    <core-ajax id="fetchUpdates"
      url="/updates" handleAs="json" auto
      on-core-response="{{placeMarkers}}">
    </core-ajax>
  </template>
  <script>
    Polymer({
      /**
       * Google Map
       *
       * @attribute map
       * @type Object
       * @default {}
       */
      map: {},
      /**
       * Map Options
       *
       * @attribute options
       * @type Object
       * @default {}
       */
      options: {},
      /** 
       * Shuttle Markers
       *
       * @attribute shuttleMarkers
       * @type Array
       * @default []
       */
      markers: [],

      ready: function() {
        this.initializeMap();
      },
      initializeMap: function() {
        // Set options and insert google map
        this.options = {
          center: {
            lat: Number(this.lat), 
            lng: Number(this.lng)
          },
          zoom: Number(this.zoom)
        };
        this.map = new google.maps.Map(this.$.mapCanvas, this.options);
        this.periodicUpdates();
      },
      checkForUpdates: function(ajax) {
        ajax.go();
      },
      periodicUpdates: function() {
        // periodically check screen setup for changes
        setInterval(this.checkForUpdates, 15000, this.$.fetchUpdates);
      },
      placeMarkers: function(event, response) {
        // Clear previous markers from map
        this.clearMarkers();
        var updates = response.response;
        // Iterate through each vehicle update
        for (i = 0; i < updates.length; i++) {
          console.log(updates[i]);
          // Create position from vehicle coordinates
          var pos = new google.maps.LatLng(updates[i]["lat"], updates[i]["lng"]);
          // Place shuttle marker on map
          var marker = new google.maps.Marker({
            position: pos,
            map: this.map,
            title: "placeholder"
          });
          this.markers.push(marker);
        }
      },
      clearMarkers: function() {
        for (i = 0; i < this.markers.length; i++) {
          this.markers[i].setMap(null);
        }
      }
    });
  </script>
</polymer-element>